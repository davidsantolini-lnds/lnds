<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mission : H√©l√®ne ‚ú® ‚Äî Ski Run (Scroll Edition)</title>
  <style>
    :root{
      --bg0:#050505;
      --pink:#ff6bd6;
      --rose:#ff9a9e;
      --pearl:#fecfef;
      --mint:#75f3c6;
      --shadow:0 30px 90px rgba(0,0,0,.55);
      --soft:0 0 60px rgba(255,107,214,.20);
      --glass:rgba(255,255,255,.08);
      --glass2:rgba(255,255,255,.12);
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      height: 820vh; /* cin√©matique longue */
      background: var(--bg0);
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial;
      overflow-x:hidden;
      overscroll-behavior-y:none;
      touch-action: pan-y; /* on garde le scroll */
    }

    /* Canvas full screen */
    canvas#game, canvas#fx{
      position:fixed; inset:0;
      width:100vw; height:100vh;
      display:block;
    }
    canvas#game{
      background:
        radial-gradient(circle at 50% 25%, #1a1025 0%, #000 70%),
        linear-gradient(180deg, #000, #06030c);
      z-index:1;
    }
    canvas#fx{ pointer-events:none; z-index:5; }

    /* HUD */
    .hud{
      position:fixed; top:14px; left:14px; right:14px;
      display:flex; gap:12px; align-items:center;
      pointer-events:none; z-index:10;
    }
    .chip{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border-radius:999px;
      background:rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(12px);
      box-shadow: 0 15px 50px rgba(0,0,0,.35);
      min-width: 190px;
    }
    .dot{ width:10px;height:10px;border-radius:50%; background:var(--mint); box-shadow:0 0 12px var(--mint); }
    .hud strong{font-size:.92rem;}
    .hud span{font-size:.82rem;color:rgba(255,255,255,.65)}
    .bar{
      flex:1; height:10px; border-radius:999px;
      background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
    }
    .bar > i{
      display:block; height:100%; width:0%;
      background:linear-gradient(90deg, var(--rose), var(--pink), var(--mint));
      box-shadow: var(--soft);
      will-change: width;
    }
    .pill{
      padding:4px 10px; border-radius:999px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      font-size:.78rem; color:rgba(255,255,255,.72);
      white-space:nowrap;
    }

    /* Start hint */
    .startHint{
      position:fixed; inset:0;
      display:grid; place-items:center;
      z-index:20;
      pointer-events:none;
      background: radial-gradient(circle at 50% 35%, rgba(255,107,214,.10), rgba(0,0,0,.72) 55%, rgba(0,0,0,.92) 100%);
      transition: opacity .6s ease, transform .6s ease;
    }
    .startHint.hidden{ opacity:0; transform: scale(.98); }

    .panel{
      pointer-events:none;
      width:min(980px, 92vw);
      background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.14);
      border-radius:28px;
      padding:26px 24px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      position:relative;
      overflow:hidden;
    }
    .panel:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(circle at 25% 20%, rgba(255,107,214,.25), transparent 45%),
        radial-gradient(circle at 75% 70%, rgba(117,243,198,.18), transparent 46%),
        radial-gradient(circle at 50% 110%, rgba(255,154,158,.16), transparent 55%);
      opacity:.95;
    }
    .panel > *{position:relative; z-index:1;}
    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      padding:8px 12px; border-radius:999px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      font-size:.85rem; color:rgba(255,255,255,.78);
      letter-spacing:.3px;
    }
    .kicker b{color:#fff; font-weight:900;}
    h1{
      margin:14px 0 8px;
      font-size: clamp(2.2rem, 4.5vw, 3.4rem);
      line-height:1.05;
      text-shadow:0 0 26px rgba(255,107,214,.24);
    }
    p{margin:10px 0 0; color:rgba(255,255,255,.80); font-size:1.06rem; line-height:1.55; max-width: 70ch;}
    .hintLine{
      margin-top:12px;
      color:rgba(255,255,255,.70);
      font-size:.95rem;
      display:flex; gap:10px; align-items:center;
    }
    .arrow{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      animation:bob 1.8s infinite;
    }
    @keyframes bob{
      0%,20%,50%,80%,100%{transform:translateY(0);}
      40%{transform:translateY(8px);}
      60%{transform:translateY(4px);}
    }

    /* Finish overlay */
    .finish{
      position:fixed; inset:0;
      display:none; place-items:center;
      z-index:25;
      background: radial-gradient(circle at 50% 35%, rgba(117,243,198,.10), rgba(0,0,0,.75) 55%, rgba(0,0,0,.92) 100%);
      padding:20px;
    }
    .finish.show{ display:grid; }

    .grid{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    .card{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius:22px;
      padding:16px 14px;
    }
    .card h3{margin:0; font-size:1.02rem; letter-spacing:.2px;}
    .small{color:rgba(255,255,255,.66); font-size:.92rem; line-height:1.45; margin-top:8px;}

    .row{display:flex; gap:12px; flex-wrap:wrap; margin-top:14px; align-items:center;}
    .btn{
      pointer-events:auto;
      cursor:pointer; border:none;
      padding:12px 16px; border-radius:16px;
      color:#fff; font-weight:900; letter-spacing:.2px;
      background:linear-gradient(90deg, var(--pink), var(--rose), var(--mint));
      box-shadow:0 25px 80px rgba(255,107,214,.20);
      border:1px solid rgba(255,255,255,.16);
      transition: transform .15s ease, filter .15s ease;
    }
    .btn:hover{transform: translateY(-1px); filter:brightness(1.06);}
    .btn.secondary{
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.14);
      box-shadow:none;
      font-weight:800;
      color:rgba(255,255,255,.86);
    }
    .fine{color:rgba(255,255,255,.62); font-size:.92rem; line-height:1.45; margin-top:10px;}

    .countdown{ margin-top:10px; display:flex; gap:12px; flex-wrap:wrap; }
    .timebox{ background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); border-radius:18px; padding:14px; min-width:110px; text-align:center; }
    .num{ font-size:2rem; font-weight:950; display:block; background:linear-gradient(90deg,var(--rose),var(--pearl)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .lab{ font-size:.75rem; text-transform:uppercase; color:rgba(255,255,255,.55); letter-spacing:1px; margin-top:4px; display:block; }

    @media (prefers-reduced-motion: reduce){
      .startHint, .finish{background: rgba(0,0,0,.9);}
    }
  </style>
</head>
<body>

<canvas id="game"></canvas>
<canvas id="fx"></canvas>

<div class="hud">
  <div class="chip">
    <i class="dot"></i>
    <div>
      <strong id="hudTitle">Ski Run ‚Äî Scroll Edition</strong><br/>
      <span id="hudSub">Scroll = descente ¬∑ souris/doigt = direction</span>
    </div>
  </div>
  <div class="bar"><i id="prog"></i></div>
  <div class="chip" style="min-width:290px; justify-content:space-between;">
    <div>
      <strong id="speed">0 km/h</strong><br/>
      <span id="score">Score 0 ¬∑ Combo x1</span>
    </div>
    <span class="pill" id="statePill">READY</span>
  </div>
</div>

<div class="startHint" id="startHint">
  <div class="panel">
    <span class="kicker"><b>STARTHOUSE</b> ¬∑ Mission H√©l√®ne</span>
    <h1>Descente ‚ÄúPS5 vibes‚Äù‚Ä¶ mais pilot√©e au scroll. üéø‚ú®</h1>
    <p>
      <b>Scrolle</b> pour prendre de la vitesse et franchir les portes.
      <b>Bouge la souris / ton doigt</b> pour carver √† gauche/droite.
      √Ä l‚Äôarriv√©e, tu d√©bloques le plan du voyage.
    </p>
    <div class="hintLine">
      <div class="arrow">‚Üì</div>
      <div>Go. Fais une descente propre. (Combo = style)</div>
    </div>
  </div>
</div>

<div class="finish" id="finish">
  <div class="panel">
    <span class="kicker"><b>FINISH LINE</b> ¬∑ Mission d√©bloqu√©e</span>
    <h1>üèÅ Run valid√©. Maintenant : le vrai voyage.</h1>
    <p>
      <b>Naples + Procida + C√¥te Amalfitaine</b>. 4 jours : √©nergie, douceur, vue, et une surprise ‚Äúsignature‚Äù.
      Z√©ro charge mentale pour toi. Tout pour le ‚Äúwow‚Äù.
    </p>

    <div class="grid">
      <div class="card">
        <h3>Boarding pass</h3>
        <div class="small">
          Mode : ‚Äúz√©ro logistique dans ta t√™te‚Äù ¬∑ Rythme : intense + doux ¬∑ KPI : ton sourire (100%)
        </div>
      </div>
      <div class="card">
        <h3>Objectif : 1er mars (Paris)</h3>
        <div class="countdown" id="countdown">
          <div class="timebox"><span class="num" id="days">00</span><span class="lab">Jours</span></div>
          <div class="timebox"><span class="num" id="hours">00</span><span class="lab">Heures</span></div>
          <div class="timebox"><span class="num" id="minutes">00</span><span class="lab">Minutes</span></div>
          <div class="timebox"><span class="num" id="seconds">00</span><span class="lab">Secondes</span></div>
        </div>
        <div class="row">
          <button class="btn" id="acceptBtn">‚úÖ J‚Äôaccepte la mission</button>
          <button class="btn secondary" id="icsBtn">üìÖ Ajouter au calendrier</button>
          <button class="btn secondary" id="copyBtn">üì® Copier l‚Äôinvitation</button>
          <button class="btn secondary" id="replayBtn">üîÅ Replay</button>
        </div>
        <div class="fine" id="fineText">PS : oui, c‚Äôest un jeu vid√©o romantique. C‚Äôest assum√©.</div>
      </div>
    </div>
  </div>
</div>

<script>
/* =========================
   0) Utils
========================= */
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const lerp  = (a,b,t)=>a+(b-a)*t;
const pad2  = (n)=>String(n).padStart(2,"0");
const prefersReduced = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

/* =========================
   1) Canvas setup
========================= */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d", { alpha:false });

const fx = document.getElementById("fx");
const fctx = fx.getContext("2d");

let DPR=1, W=0, H=0;
function resize(){
  DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  W = canvas.width = Math.floor(innerWidth * DPR);
  H = canvas.height = Math.floor(innerHeight * DPR);
  ctx.setTransform(DPR,0,0,DPR,0,0);

  fx.width = Math.floor(innerWidth * DPR);
  fx.height = Math.floor(innerHeight * DPR);
  fctx.setTransform(DPR,0,0,DPR,0,0);
}
addEventListener("resize", resize);
resize();

/* =========================
   2) Game parameters
========================= */
const hudSpeed = document.getElementById("speed");
const hudScore = document.getElementById("score");
const progEl = document.getElementById("prog");
const statePill = document.getElementById("statePill");
const startHint = document.getElementById("startHint");
const finishEl = document.getElementById("finish");

const TRACK_LEN = 5600;
const TRACK_W   = 520;
const GATE_SPACING = 170;

let gates = [];
let particles = [];
let confetti = [];

let player = {
  x: 0,
  y: 0,             // progress in track units
  speed: 0,         // computed from scroll delta
  steer: 0,         // from pointer
  combo: 1,
  comboTimer: 0,
  score: 0
};

let camera = { x:0, y:0, shake:0, fov:1.0 };
let finished = false;

/* =========================
   3) Track + gates generation
========================= */
function genGates(){
  gates = [];
  let side = -1;
  for(let gy=260; gy<TRACK_LEN; gy += GATE_SPACING){
    side *= -1;
    const offset = side * (TRACK_W*0.25 + Math.random()*TRACK_W*0.22);
    gates.push({ y:gy, x:offset, w:120, h:46, passed:false, good:null });
  }
}
genGates();

/* =========================
   4) Pointer steering (mouse + touch)
   - we steer by moving pointer horizontally
========================= */
let targetSteer = 0;
function setSteerFromClientX(clientX){
  const nx = (clientX / innerWidth) * 2 - 1; // -1..1
  targetSteer = clamp(nx, -1, 1);
}
addEventListener("mousemove", (e)=>setSteerFromClientX(e.clientX), { passive:true });

let touchSteerActive = false;
addEventListener("touchstart", (e)=>{
  if(!e.touches || !e.touches[0]) return;
  touchSteerActive = true;
  setSteerFromClientX(e.touches[0].clientX);
}, { passive:true });

addEventListener("touchmove", (e)=>{
  if(!touchSteerActive || !e.touches || !e.touches[0]) return;
  setSteerFromClientX(e.touches[0].clientX);
}, { passive:true });

addEventListener("touchend", ()=>{ touchSteerActive = false; }, { passive:true });

/* =========================
   5) Scroll -> speed + progress
   - We map scroll progress to player.y
   - We estimate "speed" from scroll delta (for vibe + particles)
========================= */
let lastScrollY = window.scrollY;
let lastScrollT = performance.now();

function getScrollFrac(){
  const maxScroll = document.body.scrollHeight - innerHeight;
  return maxScroll > 0 ? clamp(window.scrollY / maxScroll, 0, 1) : 0;
}

function updateFromScroll(){
  const nowT = performance.now();
  const dy = window.scrollY - lastScrollY;
  const dt = Math.max(0.016, (nowT - lastScrollT)/1000);

  // hide start hint after first real movement
  if(window.scrollY > 8) startHint.classList.add("hidden");

  // speed estimate (units-ish)
  const v = dy / dt; // px/s
  // smooth speed & keep positive vibe
  player.speed = lerp(player.speed, clamp(Math.abs(v), 0, 3200), 0.12);

  // progress on track
  const frac = getScrollFrac();
  player.y = frac * TRACK_LEN;

  lastScrollY = window.scrollY;
  lastScrollT = nowT;
}
addEventListener("scroll", updateFromScroll, { passive:true });
updateFromScroll();

/* =========================
   6) Drawing helpers
========================= */
function drawRoundedRect(c, x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  c.beginPath();
  c.moveTo(x+rr,y);
  c.arcTo(x+w,y,x+w,y+h,rr);
  c.arcTo(x+w,y+h,x,y+h,rr);
  c.arcTo(x,y+h,x,y,rr);
  c.arcTo(x,y,x+w,y,rr);
  c.closePath();
}

function worldToScreen(wx, wy){
  const relY = wy - camera.y;
  const depth = clamp(relY / 900, 0, 1.6);
  const scale = (1.25 - depth*0.55) * camera.fov;
  const sx = innerWidth/2 + (wx - camera.x) * scale;
  const sy = innerHeight*0.62 - relY * (0.45 * scale);
  return { x:sx, y:sy, s:scale };
}

/* =========================
   7) FX confetti
========================= */
function spawnConfetti(n=260){
  confetti = [];
  const cols = ["#ffffff","#ff9a9e","#fecfef","#75f3c6","#ff6bd6"];
  for(let i=0;i<n;i++){
    confetti.push({
      x: innerWidth/2 + (Math.random()*240 - 120),
      y: innerHeight/2 + (Math.random()*120 - 60),
      vx: (Math.random()*2 - 1) * (4 + Math.random()*10),
      vy: (Math.random()*-1) * (9 + Math.random()*12),
      g: 0.22 + Math.random()*0.18,
      s: 4 + Math.random()*7,
      r: Math.random()*Math.PI,
      vr: (Math.random()*2 - 1) * 0.25,
      c: cols[(Math.random()*cols.length)|0],
      life: 190 + (Math.random()*90|0)
    });
  }
}
function drawConfetti(){
  fctx.clearRect(0,0,innerWidth,innerHeight);
  for(const p of confetti){
    p.life--;
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.r += p.vr;
    fctx.save();
    fctx.translate(p.x, p.y);
    fctx.rotate(p.r);
    fctx.globalAlpha = Math.max(0, Math.min(1, p.life/240));
    fctx.fillStyle = p.c;
    fctx.fillRect(-p.s/2, -p.s/2, p.s, p.s*0.72);
    fctx.restore();
  }
  confetti = confetti.filter(p => p.life > 0 && p.y < innerHeight + 100);
  if(confetti.length) requestAnimationFrame(drawConfetti);
  else fctx.clearRect(0,0,innerWidth,innerHeight);
}

/* =========================
   8) Particles burst
========================= */
function burst(x,y,color){
  if(prefersReduced) return;
  for(let i=0;i<22;i++){
    particles.push({
      x, y,
      vx: (Math.random()*2-1) * (2 + Math.random()*6),
      vy: (Math.random()*2-1) * (2 + Math.random()*6),
      life: 0.55 + Math.random()*0.35,
      c: color,
      s: 2 + Math.random()*3,
      snow:false
    });
  }
}

/* =========================
   9) Main loop (scroll-driven)
========================= */
let lastT = performance.now();
function step(t){
  const dt = clamp((t - lastT)/1000, 0, 0.04);
  lastT = t;

  // steering smoothing
  player.steer = lerp(player.steer, targetSteer, 0.10);

  // map steer to x position (carving)
  // we let X "follow" pointer like a ski: stable but responsive
  const border = TRACK_W*0.48;
  const targetX = player.steer * border;
  player.x = lerp(player.x, targetX, 0.12);

  // camera follows player with a little "PS5 shake"
  camera.y = lerp(camera.y, player.y - 240, 0.10);
  camera.x = lerp(camera.x, player.x * 0.45, 0.12);

  const speed01 = clamp(player.speed / 3200, 0, 1);
  camera.fov = lerp(camera.fov, 1.0 + speed01*0.12, 0.08);
  camera.shake = lerp(camera.shake, 0, 0.08);

  // progress + HUD
  const frac = clamp(player.y / TRACK_LEN, 0, 1);
  progEl.style.width = (frac*100).toFixed(1) + "%";
  const kmh = Math.round(18 + speed01*92);
  hudSpeed.textContent = `${kmh} km/h`;
  hudScore.textContent = `Score ${Math.floor(player.score)} ¬∑ Combo x${player.combo}`;
  statePill.textContent = finished ? "FINISH" : (frac<0.02 ? "READY" : "LIVE");

  // background
  ctx.clearRect(0,0,innerWidth,innerHeight);

  // aura
  if(!prefersReduced){
    const g = ctx.createRadialGradient(innerWidth/2, innerHeight*0.25, 0, innerWidth/2, innerHeight*0.25, innerWidth*0.9);
    g.addColorStop(0, "rgba(255,107,214,.10)");
    g.addColorStop(0.55,"rgba(0,0,0,0)");
    g.addColorStop(1,"rgba(0,0,0,.0)");
    ctx.fillStyle = g;
    ctx.fillRect(0,0,innerWidth,innerHeight);
  }

  drawTrack(frac);
  handleAndDrawGates(dt);
  spawnAndDrawSnow(dt, speed01);

  // finish detect
  if(!finished && frac >= 0.999){
    finished = true;
    onFinish();
  }

  requestAnimationFrame(step);
}
requestAnimationFrame(step);

function drawTrack(progress){
  const topY = innerHeight*0.22;
  const botY = innerHeight*1.05;

  const topW = innerWidth*0.18;
  const botW = innerWidth*1.15;

  const offset = -(camera.x / (TRACK_W*0.5)) * innerWidth*0.12;

  const g = ctx.createLinearGradient(0, topY, 0, botY);
  g.addColorStop(0, "rgba(235,240,255,.78)");
  g.addColorStop(1, "rgba(205,220,245,.96)");

  ctx.fillStyle = g;
  ctx.beginPath();
  ctx.moveTo(innerWidth/2 - topW + offset, topY);
  ctx.lineTo(innerWidth/2 + topW + offset, topY);
  ctx.lineTo(innerWidth/2 + botW + offset, botY);
  ctx.lineTo(innerWidth/2 - botW + offset, botY);
  ctx.closePath();
  ctx.fill();

  // texture lines
  ctx.globalAlpha = 0.10;
  ctx.strokeStyle = "#ffffff";
  for(let i=0;i<18;i++){
    const y = topY + (i/18)*(botY-topY);
    const w = topW + (botW-topW)*(i/18);
    ctx.beginPath();
    ctx.moveTo(innerWidth/2 - w + offset, y);
    ctx.lineTo(innerWidth/2 + w + offset, y);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // edges glow
  ctx.globalAlpha = 0.10 + (progress*0.18);
  ctx.strokeStyle = "rgba(255,107,214,.7)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(innerWidth/2 - topW + offset, topY);
  ctx.lineTo(innerWidth/2 - botW + offset, botY);
  ctx.moveTo(innerWidth/2 + topW + offset, topY);
  ctx.lineTo(innerWidth/2 + botW + offset, botY);
  ctx.stroke();
  ctx.globalAlpha = 1;
  ctx.lineWidth = 1;

  // vignette + motion blur feel
  if(!prefersReduced){
    const v = ctx.createRadialGradient(innerWidth/2, innerHeight*0.65, innerWidth*0.10, innerWidth/2, innerHeight*0.65, innerWidth*0.75);
    v.addColorStop(0, "rgba(0,0,0,0)");
    v.addColorStop(1, "rgba(0,0,0,.30)");
    ctx.fillStyle = v;
    ctx.fillRect(0,0,innerWidth,innerHeight);
  }

  if(camera.shake > 0.02){
    ctx.globalAlpha = camera.shake * 0.14;
    ctx.fillStyle = "#fff";
    ctx.fillRect(0,0,innerWidth,innerHeight);
    ctx.globalAlpha = 1;
  }
}

function handleAndDrawGates(dt){
  // combo decay
  if(player.comboTimer > 0) player.comboTimer -= dt;
  else player.combo = 1;

  for(let i=gates.length-1;i>=0;i--){
    const g = gates[i];
    if(g.y < camera.y - 80) continue;
    if(g.y > camera.y + 980) continue;

    const ws = worldToScreen(g.x, g.y);
    const w = g.w * ws.s;
    const h = g.h * ws.s;

    const isRed = (i % 2 === 0);
    const col = isRed ? "rgba(255,71,100,1)" : "rgba(71,158,255,1)";
    const glow = isRed ? "rgba(255,71,100,.35)" : "rgba(71,158,255,.35)";

    ctx.save();
    ctx.translate(ws.x, ws.y);
    ctx.rotate((-player.steer) * 0.08);
    ctx.globalAlpha = clamp(ws.s*1.2, 0.15, 1);

    // shadow
    ctx.fillStyle = "rgba(0,0,0,.25)";
    drawRoundedRect(ctx, -w/2+6, -h/2+8, w, h, 10*ws.s);
    ctx.fill();

    // main
    ctx.fillStyle = col;
    ctx.shadowColor = glow;
    ctx.shadowBlur = 24*ws.s;
    drawRoundedRect(ctx, -w/2, -h/2, w, h, 12*ws.s);
    ctx.fill();
    ctx.shadowBlur = 0;

    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = `${Math.max(10, 12*ws.s)}px -apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(isRed ? "FOCUS" : "FLOW", 0, 0);

    // poles
    ctx.globalAlpha *= 0.75;
    ctx.fillStyle = "rgba(255,255,255,.95)";
    ctx.fillRect(-w/2 + 8*ws.s, -h/2 - 26*ws.s, 5*ws.s, 62*ws.s);
    ctx.fillRect( w/2 - 13*ws.s, -h/2 - 26*ws.s, 5*ws.s, 62*ws.s);

    ctx.restore();

    // pass detection (scroll-driven) once when player crosses y
    if(!g.passed && Math.abs(g.y - player.y) < 55){
      const dx = Math.abs(player.x - g.x);
      if(dx < 130){
        g.passed = true; g.good = true;
        player.combo = clamp(player.combo + 1, 1, 9);
        player.comboTimer = 1.2;

        const speed01 = clamp(player.speed/3200, 0, 1);
        const styleBonus = 1 + player.combo*0.15;
        player.score += (220 + speed01*70) * styleBonus;
        camera.shake = Math.max(camera.shake, 0.16);
        burst(ws.x, ws.y, isRed ? "#ff4764" : "#479eff");
      } else {
        g.passed = true; g.good = false;
        player.combo = 1; player.comboTimer = 0;
        player.score = Math.max(0, player.score - 120);
        camera.shake = Math.max(camera.shake, 0.30);
        burst(ws.x, ws.y, "#ffffff");
      }
    }
  }
}

function spawnAndDrawSnow(dt, speed01){
  // spawn snow streaks (screen space) based on scroll speed
  const rate = prefersReduced ? 0 : (18 + speed01*85);
  const toSpawn = Math.floor(rate * dt);

  for(let i=0;i<toSpawn;i++){
    particles.push({
      x: Math.random()*innerWidth,
      y: Math.random()*innerHeight*0.7,
      vx: (-player.steer*40) + (Math.random()*2-1)*10,
      vy: 180 + speed01*540 + Math.random()*120,
      life: 0.25 + Math.random()*0.35,
      c: "rgba(255,255,255,.9)",
      s: 1 + Math.random()*2.4,
      snow:true
    });
  }

  // draw particles
  ctx.save();
  ctx.globalCompositeOperation = "screen";
  for(const p of particles){
    p.life -= dt;
    p.x += p.vx * dt;
    p.y += p.vy * dt;

    const a = clamp(p.life/0.6, 0, 1);
    ctx.globalAlpha = p.snow ? a*0.65 : a;

    ctx.fillStyle = p.c;
    if(p.snow){
      ctx.fillRect(p.x, p.y, p.s*0.9, p.s*10);
    } else {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.s, 0, Math.PI*2);
      ctx.fill();
    }
  }
  ctx.restore();
  ctx.globalAlpha = 1;

  particles = particles.filter(p => p.life > 0 && p.y < innerHeight + 60 && p.x > -60 && p.x < innerWidth + 60);
}

/* =========================
   10) Finish
========================= */
function onFinish(){
  finishEl.classList.add("show");
  spawnConfetti();
  drawConfetti();
  statePill.textContent = "FINISH";
  document.getElementById("hudSub").textContent = "Run clean. Mission unlocked.";
}

/* =========================
   11) Replay
========================= */
document.getElementById("replayBtn").addEventListener("click", ()=>{
  // reset gates + score
  genGates();
  particles = [];
  player.score = 0;
  player.combo = 1;
  player.comboTimer = 0;
  finished = false;

  // hide finish
  finishEl.classList.remove("show");
  fctx.clearRect(0,0,innerWidth,innerHeight);

  // scroll top smoothly
  window.scrollTo({ top: 0, behavior:"smooth" });
  startHint.classList.remove("hidden");
  statePill.textContent = "READY";
  document.getElementById("hudSub").textContent = "Scroll = descente ¬∑ souris/doigt = direction";
});

/* =========================
   12) Accept + ICS + Copy
========================= */
document.getElementById("acceptBtn").addEventListener("click", () => {
  spawnConfetti(320);
  drawConfetti();
  pulseText("Mission accept√©e. Prochaine √©tape : la surprise. ‚ú®");
});

function pulseText(text){
  const el = document.getElementById("fineText");
  const old = el.textContent;
  el.textContent = text;
  el.animate([{opacity:.35},{opacity:1}],{duration:450,easing:"ease-out"});
  setTimeout(()=>{ el.textContent = old; }, 2400);
}

/* Countdown Europe/Paris */
function getZonedTimestamp({ year, monthIndex, day, hour=0, minute=0, second=0, timeZone }) {
  const utcGuess = Date.UTC(year, monthIndex, day, hour, minute, second);
  const dtf = new Intl.DateTimeFormat("en-US", {
    timeZone, hour12:false,
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
  function partsInZone(ms){
    const parts = dtf.formatToParts(new Date(ms));
    const get = (t)=> +parts.find(p=>p.type===t).value;
    return { y:get("year"), m:get("month"), d:get("day"), hh:get("hour"), mm:get("minute"), ss:get("second") };
  }
  let corrected = utcGuess;
  for(let i=0;i<2;i++){
    const p = partsInZone(corrected);
    const asIfUTC = Date.UTC(p.y, p.m-1, p.d, p.hh, p.mm, p.ss);
    const desired = Date.UTC(year, monthIndex, day, hour, minute, second);
    corrected -= (asIfUTC - desired);
  }
  return corrected;
}
const targetDate = getZonedTimestamp({ year:2026, monthIndex:2, day:1, hour:0, minute:0, second:0, timeZone:"Europe/Paris" });

setInterval(()=>{
  const now = Date.now();
  const d = targetDate - now;
  if(d <= 0){
    document.getElementById("countdown").innerHTML = `<div class="timebox" style="min-width:220px;"><span class="num">üéÇ</span><span class="lab">C‚Äôest le jour J</span></div>`;
    return;
  }
  const days = Math.floor(d/(1000*60*60*24));
  const hours = Math.floor((d%(1000*60*60*24))/(1000*60*60));
  const minutes = Math.floor((d%(1000*60*60))/(1000*60));
  const seconds = Math.floor((d%(1000*60))/1000);
  document.getElementById("days").textContent = pad2(days);
  document.getElementById("hours").textContent = pad2(hours);
  document.getElementById("minutes").textContent = pad2(minutes);
  document.getElementById("seconds").textContent = pad2(seconds);
}, 1000);

/* ICS */
function toICSDateUTC(ms){
  const d = new Date(ms);
  const p = (n)=>String(n).padStart(2,"0");
  return d.getUTCFullYear()+p(d.getUTCMonth()+1)+p(d.getUTCDate())+"T"+p(d.getUTCHours())+p(d.getUTCMinutes())+p(d.getUTCSeconds())+"Z";
}
document.getElementById("icsBtn").addEventListener("click", () => {
  const dtStart = targetDate;
  const dtEnd = targetDate + 60*60*1000;
  const uid = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"@mission"));
  const ics =
`BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
PRODID:-//Mission Helene//FR
BEGIN:VEVENT
UID:${uid}
DTSTAMP:${toICSDateUTC(Date.now())}
DTSTART:${toICSDateUTC(dtStart)}
DTEND:${toICSDateUTC(dtEnd)}
SUMMARY:üéâ Objectif 1er Mars
DESCRIPTION:Mission voyage : Naples + Procida + C√¥te Amalfitaine (Europe/Paris).
END:VEVENT
END:VCALENDAR`;
  const blob = new Blob([ics], { type:"text/calendar;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "objectif-1er-mars.ics";
  a.click();
  URL.revokeObjectURL(url);
});

/* Copy invite */
document.getElementById("copyBtn").addEventListener("click", async () => {
  const msg =
`H√©l√®ne ‚ù§Ô∏è

Je t‚Äôai cod√© une descente de ski pilot√©e au scroll (oui).
Et √† la fin : mission d√©bloqu√©e.

Naples + Procida + C√¥te Amalfitaine.
4 jours : √©nergie, douceur, vue, et une surprise ‚Äúsignature‚Äù.

Tu acceptes la mission ? ‚ú®`;
  try{
    await navigator.clipboard.writeText(msg);
    pulseText("Invitation copi√©e ‚úÖ");
  }catch(e){
    pulseText("Copie bloqu√©e ‚Äî copie manuelle affich√©e.");
    alert(msg);
  }
});
</script>
</body>
</html>
